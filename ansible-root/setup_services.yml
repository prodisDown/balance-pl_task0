---
- name: Setup VMs
  hosts: VM
  roles:
    - common

- name: Setup RabbitMQ and node_exporter
  hosts: rabbitmq
  vars:
    pb_rabbitmq_definition_vhosts:
      - vhost: /
      - vhost: testvh
    pb_rabbitmq_definition_commonUsers:
      - user: admin
        password: admin
        tags: administrator
        permissions:
          - vhost: /
            configure_priv: .*
            read_priv: .*
            write_priv: .*
          - vhost: testvh
            configure_priv: .*
            read_priv: .*
            write_priv: .*
      - user: monitoring
        password: monitoring
        tags: monitoring
        permissions:
          - vhost: testvh
            configure_priv: ^$
            read_priv: .*
            write_priv: ^$
  roles:
    - role: rabbitmq
      vars:
        rabbitmq_definition_vhosts: "{{ pb_rabbitmq_definition_vhosts }}"
        rabbitmq_definition_commonUsers: "{{ pb_rabbitmq_definition_commonUsers }}"
    - role: rabbitmq_services
      vars:
        rabbitmq_definition_serviceUsers:
        - user: service_x
          password: service_x
          permissions:
            - vhost: testvh
              configure_priv: .*
              read_priv: .*
              write_priv: .*
    - node_exporter

- name: Setup prometheus and grafana
  hosts: prometheus
  roles:
    - role: prometheus
      vars:
        prometheus_scrape:
          - job_name: "prometheus"
            static_configs:
              - targets: ['localhost:9090']
          - job_name: "rabbitmq"
            static_configs:
              - targets: "[{% for h in (groups.rabbitmq) | unique %}'{{ hostvars[h].ansible_host }}:15692',{% endfor %}]"
          - job_name: "node_exporter"
            metrics_path: '/metrics'
            scheme: 'http'
            static_configs:
              - targets: "[{% for h in groups.rabbitmq %}'{{ hostvars[h].ansible_host }}:9100',{% endfor %}]"
    - role: grafana
