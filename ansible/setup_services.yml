---
- name: Setup RabbitMQ
  hosts: rabbitmq,&VM
  vars:


    pile_of_rpm_keys:
    - name: 'rabbitmq-server'
      key: 'https://github.com/rabbitmq/signing-keys/releases/download/2.0/rabbitmq-release-signing-key.asc'

    pile_of_targets:
    - name: 'socat'     # rabbitmq-server
      type: 'repo'

    - name: 'logrotate' # rabbitmq-server
      type: 'repo'

    - name: 'erlang'    # rabbitmq-server
      type: 'rpm'
      url: 'https://github.com/rabbitmq/erlang-rpm/releases/download/v23.3.4.10/erlang-23.3.4.10-1.el7.x86_64.rpm'
      src: 'erlang.rpm'

    - name: 'rabbitmq-server'
      type: 'rpm'
      url: 'https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.9.13/rabbitmq-server-3.9.13-1.el7.noarch.rpm'
      src: 'rabbitmq-server.rpm'

    - name: 'node_exporter'
      type: 'tar'
      url: 'https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz'
      src: 'node_exporter-1.3.1.linux-amd64.tar.gz'
      creates: 'node_exporter-1.3.1.linux-amd64'


  tasks:


    # DOWNLOADS

  - name: Create working directory
    ansible.builtin.file:
      path: "/tmp/my_ansible_cwd"
      state: directory
    register: my_cwd

  - name: Import signing keys for rpm
    become: yes
    ansible.builtin.rpm_key:
      key: "{{ item.key }}"
      state: present
    loop: "{{ pile_of_rpm_keys }}"

  - name: Download targets
    ansible.builtin.get_url:
      url: "{{ item.url }}"
      dest: "{{ my_cwd.path }}/{{ item.src }}"
    when: item.type == 'rpm' or
          item.type == 'tar'
    loop: "{{ pile_of_targets }}"


  # INSTALLS

  - name: Install packages from repo
    become: yes
    ansible.builtin.yum:
      name: "{{ item.name }}"
      state: present
    when: item.type == 'repo'
    loop: "{{ pile_of_targets }}"

  - name: Install RPM-packages
    become: yes
    ansible.builtin.yum:
      name: "{{ my_cwd.path }}/{{ item.src }}"
      state: present
    when: item.type == 'rpm'
    loop: "{{ pile_of_targets }}"

  - name: Install to /opt
    become: yes
    ansible.builtin.unarchive:
      remote_src: yes
      list_files: yes
      owner: root
      group: root
      src: "{{ my_cwd.path }}/{{ item.src }}"
      dest: '/opt'
      creates: "/opt/{{ item.creates }}"
    when: item.type == 'tar'
    loop: "{{ pile_of_targets }}"
